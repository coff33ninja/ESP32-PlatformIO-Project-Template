name: Dependency Updates

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools platformio
    
    - name: Update Python dependencies
      run: |
        # Update requirements.txt
        pip-compile --upgrade requirements.in || echo "No requirements.in found, skipping Python updates"
    
    - name: Update PlatformIO libraries
      run: |
        pio lib update
        pio pkg update
    
    - name: Check for security vulnerabilities
      run: |
        pip install safety>=2.0.0
        echo "platformio>=6.1.0" > temp_requirements.txt
        echo "esptool>=4.0.0" >> temp_requirements.txt
        echo "pyserial>=3.5" >> temp_requirements.txt
        safety check -r temp_requirements.txt || echo "Security issues found - will be addressed in PR"
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update dependencies'
        title: 'chore: weekly dependency updates'
        body: |
          ## Automated Dependency Updates
          
          This PR contains automated updates for:
          - Python packages (requirements.txt)
          - PlatformIO libraries and packages
          
          ### Changes Made
          - Updated Python dependencies to latest compatible versions
          - Updated PlatformIO libraries and core packages
          - Ran security vulnerability scan
          
          ### Testing Required
          - [ ] Build verification for all environments
          - [ ] Basic functionality testing
          - [ ] Security scan review
          
          **Note**: This is an automated PR. Please review changes carefully before merging.
        branch: automated/dependency-updates
        delete-branch: true
        labels: |
          dependencies
          automated
          chore